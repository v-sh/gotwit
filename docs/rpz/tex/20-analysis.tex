\chapter{Аналитический раздел}
\label{cha:analysis}
%
% % В начале раздела  можно напомнить его цель
%
%В данном разделе анализируется и классифицируется существующая всячина и пути создания новой всячины. А вот отступ справа в 1 см.~--- это хоть и по ГОСТ, но ведь диагноз же...

Целью данного раздела является аналитическое исследования предметной области.
Для этого необходимо:
\begin{itemize}
\item подробно описать предметную облать;
\item определить требования к структуре базы данных;
\item разработать логическую модель данных.
\end{itemize}

\section{Описание предметной области}
%тут описывается ЧТО НУЖНО, СДЕЛАТЬ, ВСЕ ФУНКЦИИ, ОСНОВНЫЕ КЕЙСЫ ИСПОЛЬЗОВАНИЯ


Новостная социальная сеть предоставляет следующую функциональность:
\begin{itemize}
\item регистрация пользователей;
\item публикация сообщений, содержащих текст и изображение(не обязательно);
\item повторная публикация сообщений, ранее опубликованных другими пользователями;
\item комментирование сообщений;
\item выражение своего отношения к публикации посредством кнопок ``нравится'' и ``не нравится'';
\item отображение списков публикаций.
\end{itemize}

Каждый пользователь при регистрации может указать свои имя,
фамилию, ``ник'', некоторое текстовое описание в произвольной форме, пол,
дату рождения и адрес электронной почты.
Так же пользователь может установить изображение в качестве ``аватара''.
Аватары пользователя отображаются на его странице и рядом с его публикациями.
Вся эта информация может быть изменена пользователем,
если это допускается ограничениями.
Ник является уникальным идентификатором пользователя 
и используется для формирования адреса его страницы.
При регистрации аккаунт пользователя привязывается к некоторому адресу электронной
почты.
Так же пользователь указывает пароль при регистрации.

Обязательными для пользователя являются только ``ник'', электронный адрес и пароль.
В случае если аватар пользователя не задан, то отображается некоторое изображение
по умолчанию.

Процесс регистрации пользователя должен быть завершен посредством отправки на указанный электронный ящик письма,
содержащего некоторую ссылку, переход по которой является подтверждением наличия у пользователя доступа к указанному
электронному ящику.


Пользователи получают доступ в систему при помощи адреса электронной почты и
пароля.
Пароль пользователя не может быть сохранен в БД в прямом виде, и должен отвечать
некоторым требованиям сложности.
Пароль может быть сброшен пользователем, если он забыл его,
в этом случае пользователю на его электронный адрес будет отправлено письмо,
содержащее ссылку для сброса пароля,
пароль сбрасывается только при переходе по этой ссылке
и успешном вводе нового пароля.
Если пользователь не завершил эти действия, старый пароль остается в силе.
Ссылка для сброса пароля действительна только 1 день,
и может быть использована только один раз.
Пользователь может получить новую ссылку для сброса пароля,
только если не существует еще действительной другой ссылки сброса пароля.
Если пользователь успешно авторизуется при помощи текущего логина и пароля, то
действительная ссылка для сброса пароля обьявляется недействительной.
Так же пользователь может сменить пароль на странице анкеты, при помощи текущего пароля.
Ссылки для сброса пароля содержат некоторый константный префикс и идентификатор ссылки сброса(далее ``токен'').
Токен представляет собой некторую строку состоящую из букв латинского
алфавита различного регистра и цыфр длинной 30 символов.

Электронный адрес пользователя доступен для чтения только самому пользователю
и не может быть изменен.

Пользователи могут создавать публикации, содержащие текст и изображение,
ограниченные по размеру.
В будущем возможно увеличение числа изображений содержащихся в одной публикации.



Пользователи могут подписываться на публикации других пользователей, 
выражать свое отношение к публикации по средством кнопок ``нравится'' и 
``не нравится''.
Для каждой публикации выводиться число пользователей выразивших свое отношение
в каждой из категорий ``нравится'' и ``не нравится''.
Пользователь одновременно может выразить свое отношение только в одной из категорийи только один раз.

Публикации предоставляются пользователям в виде ``лент''.
Существует два типа лент: лента публикаций конкретного пользователя и 
агрегированная лента.

Лента публикаций конкретного пользователя представляет собой отсортированную 
по времени последовательность публикаций этого пользователя и повторных
публикаций, сделанных им.

Агрегированная лента составляется как отсортированная по времени
последовательность публикаций и повторных публикаций пользователей,
на которых подписан текущий пользователь. 

Публикации выводятся с прикрепленными к ним 
счетчиками ``нравится'' и ``не нравится'', комментариями, датой и временем создания.
Рядом с публикациями и повторными публикациями всегда выводится аватар и ник
пользователя, который опубликовал или повторно опубликовал данное
сообщение соответственно.
Рядом с повторными публикациями дополнительно выводится аватар и ник пользователя,
который первым опубликовал данное сообщение.

Пользователи могут повторно опубликовывать любое сообщение посредством одного
нажатия кнопки мыши.
Комментарии и отметки ``нравится''\/``не нравится'' прикрепляются к повторной публикации,
если пользователь их оставляющий работал именно с повторной публикацией.


Комментарии выводятся в отсортированном по времени создания виде,
последние 2 комментария выводятся всегда,
остальные могут быть спрятаны, но должны быть доступны.
Для каждого комментария указываются дата создания, ник и аватар его автора.

Б\'{о}льшую часть времени пользователи подобных социальных сетей проводят
посещая страницы других пользователей и читая агрегированную ленту.

Страница пользователя будет содержать:
\begin{itemize}
\item аватар пользователя;
\item анкетные данные пользователя;
\item список пользователей, на которых подписан данный пользователь(только если такие есть);
\item список пользователей, подписанных на данного пользователя(только если такие есть);
\item ленту его публикаций(возможно пустую).
\end{itemize}

Для агрегированной ленты пользователя так же должна быть создана 
отдельная страница.

\section{Определение требований к структуре базы данных}

\subsection{Определение целей создания системы}

Основной целью новостной социальной сети является предоставление пользователям
возможности обмениваться новостями(опубликованными сообщениями).
Новостная лента является достаточно удобным способом получения информации
от разных источников,
а новостная социальная сеть позволяет также удобным образом настраивать
ленту с помощью системы подписок.
Пользователи смогут подписываться на публикации своих друзей и других интерестных
им пользователей. 

\subsection{Определение обьема и типов данных}

Исходя из анализа предметной области можно выделить следующие категории данных:
\begin{itemize}
\item пользователи
\item публикации
\item комментарии
\item изображения
\item отметки ``нравится'' и ``не нравится''
\item списоки подписок пользователя на других пользователей
\end{itemize}

Для категории пользователей необходимо хранить следующие сведения:
\begin{itemize}
\item электронный адрес, к которому привязан аккаунт данного пользователя;
\item пароль(в искаженном виде);
\item токен сброса пароля;
\item ник;
\item аватар;
\item имя;
\item фамилия;
\item дата рождения;
\item пол;
\item описание.
\end{itemize}

Для категории публикаций:
\begin{itemize}
\item текст;
\item изображение;
\item автор;
\item время создания.
\end{itemize}
Публикация может быть повторной.

Для категории комментариев:
\begin{itemize}
\item текст;
\item время создания;
\item автор;
\item комментируемый пост.
\end{itemize}

Для категории изображений:
\begin{itemize}
\item файл изображения;
\item загрузивший пользователь.
\end{itemize}

Для отметок ``нравится''\/``не нравится'':
\begin{itemize}
\item положительная \/ отрицаительная;
\item пользователь, ее создавший;
\item публикация к которой относится отметка.
\end{itemize}


Ожидаемое количество пользователей системы не превышает 100 000 000 человек,
из них примерно 10 000 000 активных.
Имя пользователя, его ник и фамилия не могут быть более двадцати символов, электронный адрес пользователя не может быть более 50-и символов.

Ожидаемое среднее число подписок на одного пользователя не превышает трехсот.

Предполагается, что все пользователи или наибольшая их часть будут иметь аватары.
Аватар - изображение  в формате jpeg, не превышающее по размеру 10 MiB.

Предполагается, что в среднем пользователи будут создавать одну публикацию 
в неделю.
Текст публикации не может быть больше 1000 символов.
Изображение прикрепленное к публикации так же как и аватар 
должно быть в формате jpeg и не превышать по размеру 10 MiB.
Для каждой публикации хранится время ее создания в формате unix-time.
Ожидается, что в среднем на одну публикацию будет приходиться 
одна повторная публикация.

Комментарии к постам представляют из себя текст не превышающий 500 символов.
Для комментариев так же хранится время их создания.
Предполагается, что в среднем к каждой публикации будет прикреплен 1 комментарий.

Ожидаемое число отметок ``нравится'' и ``не нравится'' - 10 на каждую публикацию.

Срок жизни проекта - 5 лет.

\subsection{Определение способа использования данных}

Каждый пользователь может одновременно выступать в двух ролях:
\begin{itemize}
\item постовщика контента;
\item читателя новостной ленты.
\end{itemize}

Выступая в роли поставщика контента, пользователи будут создавать публикации.

Выступая в роли читателя лент, пользователи будут просматривать страницы других пользователей,
подписываться на их публикации, обсуждать публикации и голосовать за них отметками ``нравится''\/``не нравится''

%категории пользователей
%потенциальный рост
%задачи пользователей


\subsection{Определение бизнес-правил}
%поля и всякие констрэйинты
%ох ща напишу так напишу =)
База данных должна соответсвовать следующим группам бизнес-правил.

Правила связанные с пользоватем:
\begin{itemize}
\item сведения о пользователе содержат: ник, пароль, имя, фимилию, дату рождени, пол, описание, аватар;
\item ник пользователя является идентификатором, состоящим из латинских букв и цифр.;
\item ник пользователя является униальным;
\item ник пользователя является обязательным;
\item пароль пользователя не должен быть короче 6 символов;
\item пароль пользователя может включать в себя только латинские буквы и цифры;
\item пароль пользователя является обязательным;
\item имя пользователя не может быть длиннее 20 символов, но может включать любые символы;
\item фамилия пользователя не может быть длиннее 20 символов, но может включать любые символы;
\item имя пользователя может быть не указано;
\item фамилия пользователя может быть не указана;
\item дата рождения пользователя находится в диапазоне от 1900 г. до текущего времени;
\item дата рождения пользователя может быть не указана;
\item пол пользователя может принимать два значения ``М''\/``Ж'';
\item пол пользователя может быть не указан;
\item описание пользователя может содержать любые символы, но по длинне не превышает 300 символов;
\item аватар пользователя может быть не указан.
\end{itemize}

Правила связанные с процессом регистрации пользователя:
\begin{itemize}
\item пользователь может зарегистрироваться только указав все обязательные данные;
\item пользователь является зарегистрированным только после прохождения процесса верификации;
\item верификации пользователя осуществляется путем отправки ему на электронный ящик специальной ссылки,
  переход по которой завершает верификацию.
\item можно зарегистрировать пользователя с определенным ником только в том случаях, если такой пользователь
  еще не зарегистрирован, либо если существующий пользователь с таким ником не верефицированн.
\end{itemize}

Правила связанные с публикациями пользователей:
\begin{itemize}
\item сведения о публикации включают: автора, текст, изображение, время создания;
\item для публикации обязательно указание автора;
\item только сам пользователь может опубликовать что-то под своим авторством;
\item пользователь может повторно опубликовать публикацию другого пользователя, без внесение изменений в
  ее содержание и с обязательной ссылкой на автора;
\item текст публикации не может быть длинее 1000 символов;
\item текст публикации может отсутсвовать, если присутствует изображение;
\item изображение прикрепленное к публикации может отсутсвовать, если присутсвует текст;
\item время создания публикации является обязательным полем, и всегда равно времени регистрации публикации в БД;
\end{itemize}

Правила связанные с комментариями и отметками пользователей:
\begin{itemize}
\item сведения о комментарии пользователя содержат: текст, дату и время создания, ссылку на публикацию, автора;
\item текст комментария является обязательным;
\item текст комментария не может быть длиннее 500 символов;
\item датой и временем создания комментария считается момент регистрации комментария в БД;
\item ссылка на публикацию является обязательной для комментария;
\item автор комментария должен быть указан;
\item только сам пользователь может создать комментарий под своим авторством;
\item пользователь может выразить свое отношение к публикации( в том числе повтороной) только в одной
  из категорий ``нравится''\/``не нравится'' и только один раз;
\end{itemize}

Правила связанные с подписками пользователей и лентами публикаций:
\begin{itemize}
\item kj
\end{itemize}




\section{Разработка логической модели данных}

\subsection{Отпределение сущьностей, связей между ними и атрибутов сущьностей}
%разработка таблиц(сущьностей) на уровне логики

\subsection{Определение ограничений налагаемых на данные}

%полное описание наличия всех констрэинтов и их отсуствия тоже( есть значение, оно не обязательно, оно ключ ..., оно ключ, который торчит в пустоту)

\subsection{Диаграмма БД}
На рисунке \ref{fig:er} представлена ER-диаграмма проекта.
\begin{landscape}
\begin{figure}
  \centering
  \includegraphics[width=1.3\textwidth]{inc/dia/er}
  \caption{ER-диаграмма}
  \label{fig:er}
\end{figure}
\end{landscape}
\cite{cha:analysis}
% Обратите внимание, что включается не ../dia/..., а inc/dia/...
% В Makefile есть соответствующее правило для inc/dia/*.pdf, которое
% берет исходные файлы из ../dia в этом случае.

%\begin{figure}
%  \centering
%  \includegraphics[width=\textwidth]{inc/dia/rpz-idef0}
%  \caption{Рисунок}
%  \label{fig:fig01}
%\end{figure}

%В \cite{Pup09} указано, что...

%Кстати, про картинки. Во-первых, для фигур следует использовать \texttt{[ht]}. Если и после этого картинки вставляются <<не по ГОСТ>>, т.е. слишком далеко от места ссылки,~--- значит у вас в РПЗ \textbf{слишком мало текста}! Хотя и ужасный параметр \texttt{!ht} у окружения \texttt{figure} тоже никто не отменял, только при его использовании документ получается страшный, как в ворде, поэтому просьба так не делать по возможности.


%Известны следующие подходы...

%\begin{enumerate}
%\item Перечисление с номерами.
%\item Номера первого уровня. Да, ГОСТ требует именно так~--- сначала буквы, на втором уровне~--- цифры.
%Чуть ниже будет вариант <<нормальной>> нумерации и советы по её изменению.
%Да, мне так нравится: на первом уровне выравнивание элементов как у обычных абзацев. Проверим теперь вложенные списки.
%\begin{enumerate}
%\item Номера второго уровня.
%\item Номера второго уровня. Проверяем на длииииной-предлиииииииииинной строке, что получается.... Сойдёт.
%\end{enumerate}
%\item По мнению Лукьяненко, человеческий мозг старается подвести любую проблему к выбору
%  из трех вариантов.
%\item Четвёртый (и последний) элемент списка.
%\end{enumerate}

%Теперь мы покажем, как изменить нумерацию на «нормальную», если вам этого захочется. Пара команд в начале документа поможет нам.


%\begin{enumerate}
%\item Изменим нумерацию на более привычную...
%\item ... нарушим этим гост.
%\begin{enumerate}
%\item Но, пожалуй, так лучше.
%\end{enumerate}
%\end{enumerate}

%В заключение покажем произвольные маркеры в списках. Для них нужен пакет \textbf{enumerate}.
%\begin{enumerate}[1.]
%\item Маркер с арабской цифрой и с точкой.
%\item Маркер с арабской цифрой и с точкой.
%\begin{enumerate}[I.]
%\item Римская цифра с точкой.
%\item Римская цифра с точкой.
%\end{enumerate}
%\end{enumerate}

%В отчётах могут быть и таблицы~--- см. табл.~\ref{tab:tabular} и~\ref{tab:longtable}.
%Небольшая таблица делается при помощи \Code{tabular} внутри \Code{table} (последний
%полностью аналогичен \Code{figure}, но добавляет другую подпись).

%% \begin{table}[ht]
%%  \caption{Пример короткой таблицы с длинным названием на много длинных-длинных строк}
%%  \begin{tabular}{|r|c|c|c|l|}
%%  \hline
%%   Тело      & $F$ & $V$  & $E$ & $F+V-E-2$ \\
%%   \hline
%%   Тетраэдр  & 4   & 4    & 6   & 0         \\
%%   Куб       & 6   & 8    & 12  & 0         \\
%%   Октаэдр   & 8   & 6    & 12  & 0         \\
%%   Додекаэдр & 20  & 12   & 30  & 0         \\
%%   Икосаэдр  & 12  & 20   & 30  & 0         \\
%%   \hline
%%   Эйлер     & 666 & 9000 & 42  & $+\infty$ \\
%%   \hline
%%   \end{tabular}
%%   \label{tab:tabular}
%% \end{table}

%% Для больших таблиц следует использовать пакет \Code{longtable}, позволяющий создавать
%% таблицы на несколько страниц по ГОСТ.

%% Для того, чтобы длинный текст разбивался на много строк в пределах одной ячейки, надо в
%% качестве ее формата задавать \texttt{p} и указывать явно ширину: в мм/дюймах
%% (\texttt{110mm}), относительно ширины страницы (\texttt{0.22\textbackslash textwidth})
%% и~т.п.

%% Можно также использовать уменьшенный шрифт~--- но, пожалуйста, тогда уж во \textbf{всей}
%% таблице сразу.

%% \begin{center}
%%   \begin{longtable}{|p{0.40\textwidth}|c|p{0.30\textwidth}|}
%%     \caption{Пример длинной таблицы с длинным названием на много длинных-длинных строк}
%%     \label{tab:longtable}
%%     \\ \hline
%%     Вид шума & Громкость, дБ & Комментарий \\
%%     \hline \endfirsthead
%%     \subcaption{Продолжение таблицы~\ref{tab:longtable}}
%%     \\ \hline \endhead
%%     \hline \subcaption{Продолжение на след. стр.}
%%     \endfoot
%%     \hline \endlastfoot
%%     Порог слышимости             & 0     &                                                \\
%%     \hline
%%     Шепот в тихой библиотеке     & 30    &                                                \\
%%     Обычный разговор             & 60-70 &                                                \\
%%     Звонок телефона              & 80    & \small{Конечно, это было до эпохи мобильников} \\
%%     Уличный шум                  & 85    & \small{(внутри машины)}                        \\
%%     Гудок поезда                 & 90    &                                                \\
%%     Шум электрички               & 95    &                                                \\
%%     \hline
%%     Порог здоровой нормы         & 90-95 & \small{Длительное пребывание на более
%%     громком шуме может привести к ухудшению слуха}                                        \\
%%     \hline
%%     Мотоцикл                     & 100   &                                                \\
%%     Power Mower                  & 107   & \small{(модель бензокосилки)}                  \\
%%     Бензопила                    & 110   & \small{(Doom в целом вреден для здоровья)}     \\
%%     Рок-концерт                  & 115   &                                                \\
%%     \hline
%%     Порог боли                   & 125   & \small{feel the pain}                          \\
%%     \hline
%%     Клепальный молоток           & 125   & \small{(автор сам не знает, что это)}          \\
%%     \hline
%%     Порог опасности              & 140   & \small{Даже кратковременное пребывание на
%%     шуме большего уровня может привести к необратимым последствиям}                       \\
%%     \hline
%%     Реактивный двигатель         & 140   &                                                \\
%%                                  & 180   & \small{Необратимое полное повреждение
%%                                  слуховых органов}                                        \\
%%     Самый громкий возможный звук & 194   & \small{Интересно, почему?..}                   \\
%%   \end{longtable}
%% \end{center}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "rpz"
%%% End:
